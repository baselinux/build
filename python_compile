#!/bin/bash

set -e  # Exit on error

# Variables
PYTHON_VERSION="3.12.3"
TARGET_DIR="${1}"
INSTALL_DIR="${2}"

# Download Python source
wget "https://www.python.org/ftp/python/${PYTHON_VERSION}/Python-${PYTHON_VERSION}.tar.xz" -P "${TARGET_DIR}"

# Extract source
tar -xvf "${TARGET_DIR}/Python-${PYTHON_VERSION}.tar.xz" -C "${TARGET_DIR}"
cd "${TARGET_DIR}/Python-${PYTHON_VERSION}"

# Configure build
./configure \
    CFLAGS="-fprofile-arcs -ftest-coverage" \
    CXXFLAGS="-fPIC -fprofile-arcs -ftest-coverage" \
    LDFLAGS="-static -static-libgcc -static-libstdc++" \
    --disable-shared \
    --prefix="${INSTALL_DIR}" \
    CC="i686-linux-gnu-gcc" \
    CXX="i686-linux-gnu-g++"

# Build and install
make LINKFORSHARED=" " -j$(nproc)
make install