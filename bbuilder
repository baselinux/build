#!/bin/bash

set -e

# Define versions
KERNEL_VERSION=$(cat versions/linux)
BUSYBOX_VERSION=$(cat versions/busybox)

# Define directories and URLs
WORK_DIR="${PWD}/BaseLinux"
ISO_DIR="${WORK_DIR}/iso"
KERNEL_DIR="${WORK_DIR}/iso/boot"
KERNEL_URL="https://cdn.kernel.org/pub/linux/kernel/v6.x/linux-${KERNEL_VERSION}.tar.xz"
BUSYBOX_URL="https://busybox.net/downloads/busybox-${BUSYBOX_VERSION}.tar.bz2"

# Create necessary directories
mkdir -p ${WORK_DIR} ${ISO_DIR} ${KERNEL_DIR} 

# Update package manager and install dependencies
sudo apt update
sudo apt install -y build-essential gcc make bison flex libssl-dev bc wget cpio grub-pc-bin git fakeroot libelf-dev ncurses-dev xz-utils initramfs-tools mtools

# Download and compile the Linux kernel
wget ${KERNEL_URL} -P ${WORK_DIR}
tar -xvf ${WORK_DIR}/linux-${KERNEL_VERSION}.tar.xz -C ${WORK_DIR}
cd ${WORK_DIR}/linux-${KERNEL_VERSION}
make defconfig
make -j$(nproc)
make modules_install INSTALL_MOD_PATH=${ISO_DIR}
make install INSTALL_PATH=${KERNEL_DIR}
cd ..

# Download and compile BusyBox
wget ${BUSYBOX_URL} -P ${WORK_DIR}
tar -xvf ${WORK_DIR}/busybox-${BUSYBOX_VERSION}.tar.bz2 -C ${WORK_DIR}
cd ${WORK_DIR}/busybox-${BUSYBOX_VERSION}
make defconfig
make -j$(nproc)
make install CONFIG_PREFIX=${WORK_DIR}/rootfs
cd ..

# Create root filesystem directory structure
mkdir -p ${WORK_DIR}/rootfs/{bin,dev,etc,home,lib,proc,sbin,sys,tmp,usr,var}

# Copy BusyBox files to ISO
cp -r ${WORK_DIR}/rootfs/* ${ISO_DIR}/

# Add necessary libraries
cp /lib/x86_64-linux-gnu/{libc.so.6,libm.so.6,libresolv.so.2,ld-linux-x86-64.so.2} ${ISO_DIR}/lib/

# Create init script
cat > ${ISO_DIR}/init << 'EOF'
#!/bin/sh
mount -t proc none /proc
mount -t sysfs none /sys
exec /bin/sh
EOF
chmod +x ${ISO_DIR}/init

# Create initial ramdisk
cd ${ISO_DIR}
find . | cpio -o --format=newc | gzip > ${WORK_DIR}/initrd.img
cd ${WORK_DIR}

# Create GRUB configuration
mkdir -p ${ISO_DIR}/boot/grub
cat > ${ISO_DIR}/boot/grub/grub.cfg << EOF
set timeout=5
set default=0

menuentry "BaseLinux with BusyBox" {
    linux /boot/vmlinuz
    initrd /boot/initrd.img
    init=/bin/busybox
}
EOF

# Copy kernel and initrd to ISO
mv ${KERNEL_DIR}/vmlinuz-${KERNEL_VERSION} ${KERNEL_DIR}/vmlinuz
ls ${WORK_DIR}
ls ${KERNEL_DIR}
cp -r ${WORK_DIR}/initrd.img ${ISO_DIR}/boot/

# Create bootable ISO
grub-mkrescue -o ${WORK_DIR}/BaseLinux.iso ${ISO_DIR}

echo "BaseLinux ISO created successfully: ${WORK_DIR}/BaseLinux.iso"

# Clean up
rm -rf ${WORK_DIR}/rootfs ${WORK_DIR}/initrd.img ${WORK_DIR}/linux-${KERNEL_VERSION} ${WORK_DIR}/busybox-${BUSYBOX_VERSION}

echo "To test the ISO with QEMU, run: qemu-system-x86_64 -cdrom ${WORK_DIR}/BaseLinux.iso"
